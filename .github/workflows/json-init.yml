name: JSON Content Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      mode:
        description: "运行模式：检查单个 PR 或批量检查所有 open PR"
        required: true
        default: "single"
        type: choice
        options:
          - single
          - all_open
      pr_number:
        description: "要检查的 PR 编号（例如 123）。mode=single 时必填"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (pull_request)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get changed files
        if: github.event_name == 'pull_request'
        id: changed
        uses: tj-actions/changed-files@v44

      - name: Debug changed-files outputs
        if: github.event_name == 'pull_request'
        run: |
          echo "any_changed=${{ steps.changed.outputs.any_changed }}"
          echo "all_changed_files=${{ steps.changed.outputs.all_changed_files }}"

      - name: Validate possible JSON files
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          echo "Starting JSON validation..."
          failed=0

          api_get() {
            local url="$1"
            curl -sS -L \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "$url"
          }

          validate_files_in_repo() {
            local pr_label="$1"
            local list_file="$2"

            while IFS= read -r file; do
              [ -z "$file" ] && continue
              echo "[$pr_label] Checking $file"

              # 跳过删除的文件
              if [ ! -f "$file" ]; then
                continue
              fi

              # 判断文件是否可能是 JSON（以 { 或 [ 开头）
              first_char=$(head -c 1 "$file" | tr -d '[:space:]')

              if [[ "$first_char" == "{" || "$first_char" == "[" ]]; then
                echo "[$pr_label] Possible JSON detected in $file"

                if ! jq empty "$file" > /dev/null 2>&1; then
                  echo "[$pr_label] ❌ Invalid JSON in $file"
                  failed=1
                else
                  echo "[$pr_label] ✅ Valid JSON in $file"
                fi
              fi
            done < "$list_file"
          }

          get_pr_files_to_tmp() {
            local pr_number="$1"
            local out_file="$2"

            : > "$out_file"
            local page=1
            while true; do
              resp="$(api_get "https://api.github.com/repos/${OWNER}/${REPO}/pulls/${pr_number}/files?per_page=100&page=${page}")"
              count="$(echo "$resp" | jq 'length')"
              if [ "$count" -eq 0 ]; then
                break
              fi
              echo "$resp" | jq -r '.[].filename' >> "$out_file"
              if [ "$count" -lt 100 ]; then
                break
              fi
              page=$((page + 1))
            done
          }

          checkout_pr_head() {
            local pr_number="$1"
            echo "Fetching PR #$pr_number head..."
            git fetch --no-tags --prune origin "refs/pull/${pr_number}/head:pr-${pr_number}"
            git checkout -f "pr-${pr_number}"
          }

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            mode="${{ inputs.mode }}"
            if [ "$mode" = "single" ]; then
              pr="${{ inputs.pr_number }}"
              if [ -z "$pr" ]; then
                echo "mode=single 需要提供 pr_number"
                exit 1
              fi

              checkout_pr_head "$pr"
              get_pr_files_to_tmp "$pr" /tmp/changed_files.txt
              if [ ! -s /tmp/changed_files.txt ]; then
                echo "No files found from PR API. Skipping validation loop."
                exit 0
              fi
              validate_files_in_repo "PR#$pr" /tmp/changed_files.txt
            elif [ "$mode" = "all_open" ]; then
              echo "Listing open PRs..."
              prs=()
              page=1
              while true; do
                resp="$(api_get "https://api.github.com/repos/${OWNER}/${REPO}/pulls?state=open&per_page=100&page=${page}")"
                count="$(echo "$resp" | jq 'length')"
                if [ "$count" -eq 0 ]; then
                  break
                fi
                while IFS= read -r num; do
                  [ -z "$num" ] && continue
                  prs+=("$num")
                done < <(echo "$resp" | jq -r '.[].number')
                if [ "$count" -lt 100 ]; then
                  break
                fi
                page=$((page + 1))
              done

              if [ "${#prs[@]}" -eq 0 ]; then
                echo "No open PRs found."
                exit 0
              fi

              echo "Found ${#prs[@]} open PR(s): ${prs[*]}"

              for pr in "${prs[@]}"; do
                echo "=============================="
                echo "Validating PR #$pr"
                checkout_pr_head "$pr"
                get_pr_files_to_tmp "$pr" /tmp/changed_files.txt
                if [ ! -s /tmp/changed_files.txt ]; then
                  echo "[PR#$pr] No changed files. Skipping."
                  continue
                fi
                validate_files_in_repo "PR#$pr" /tmp/changed_files.txt
              done
            else
              echo "Unknown mode: $mode"
              exit 1
            fi
          else
            changed_files="${{ steps.changed.outputs.all_changed_files }}"
            if [ -z "$changed_files" ]; then
              echo "No changed files detected. Skipping validation loop."
              exit 0
            fi
            printf "%s\n" $changed_files > /tmp/changed_files.txt
            validate_files_in_repo "PR" /tmp/changed_files.txt
          fi

          if [ "$failed" -ne 0 ]; then
            echo "JSON validation failed."
            exit 1
          fi
